{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
.lesson-number-free {
    background: #28a745 !important;
}
.lesson-number-premium {
    background: #0056d2 !important;
}
.lesson-play-icon-free {
    color: #28a745 !important;
}
.lesson-play-icon-premium {
    color: #0056d2 !important;
}
.lesson-item-active-free {
    background: #f0fff4 !important;
    border: 2px solid #28a745 !important;
}
.lesson-item-active-premium {
    background: #f0f7ff !important;
    border: 2px solid #0056d2 !important;
}
.lesson-item-inactive {
    background: #fff !important;
    border: 2px solid #d1d7dc !important;
}
</style>


<!-- Page info -->
<div class="page-info-section" style="background: linear-gradient(180deg, #0056d2 0%, #004182 100%); height: 200px; margin-top: 70px; display: flex; align-items: center;">
  <div class="container">
    <div class="site-breadcrumb">
      <a href="{% url 'courses:home' %}" style="color: rgba(255,255,255,0.8);">Home</a>
      <a href="{% url 'courses:course_list' %}" style="color: rgba(255,255,255,0.8);">Courses</a>
      <span style="color: #fff;">{{course.title|capfirst}}</span>
    </div>
  </div>
</div>
<!-- Page info end -->


<!-- single course section -->
<section class="single-course spad pb-0" style="background: #f7f9fa; padding-top: 40px; padding-bottom: 60px;">
  <div class="container">
    <div class="course-meta-area" style="margin-bottom: 40px;">
      <div class="row">
        <div class="col-lg-10 offset-lg-1">
          <div class="course-note">Featured Course</div>
          <h3 style="color: #1c1d1f; font-size: 32px; font-weight: 700; margin-bottom: 24px;">{{course.title|capfirst}}</h3>
          <div class="course-metas" style="margin-bottom: 24px;">
            <div class="course-meta">
              <div class="course-author">
                <div class="ca-pic set-bg" data-setbg="{% static 'webuni/img/authors/2.jpg' %}" style="width: 40px; height: 40px;"></div>
                <h6 style="color: #6a6f73; font-size: 12px; font-weight: 400; margin-bottom: 4px;">Instructor</h6>
                <p style="color: #1c1d1f; font-size: 14px; font-weight: 600; margin: 0;">{{course.creator|capfirst}}</p>
              </div>
            </div>
            <div class="course-meta">
              <div class="cm-info">
                <h6 style="color: #6a6f73; font-size: 12px; font-weight: 400; margin-bottom: 4px;">Category</h6>
                <p style="color: #1c1d1f; font-size: 14px; font-weight: 600; margin: 0;">{{course.category|capfirst}}</p>
              </div>
            </div>
            <div class="course-meta">
              <div class="cm-info">
                <h6 style="color: #6a6f73; font-size: 12px; font-weight: 400; margin-bottom: 4px;">Students</h6>
                <p style="color: #1c1d1f; font-size: 14px; font-weight: 600; margin: 0;">120 enrolled</p>
              </div>
            </div>
            <div class="course-meta">
              <div class="cm-info">
                <h6 style="color: #6a6f73; font-size: 12px; font-weight: 400; margin-bottom: 4px;">Rating</h6>
                <p style="color: #1c1d1f; font-size: 14px; font-weight: 600; margin: 0;">
                  <span class="rating">
                    <i class="fa fa-star" style="color: #fbb710;"></i>
                    <i class="fa fa-star" style="color: #fbb710;"></i>
                    <i class="fa fa-star" style="color: #fbb710;"></i>
                    <i class="fa fa-star" style="color: #fbb710;"></i>
                    <i class="fa fa-star is-fade" style="color: #e0e3e4;"></i>
                  </span>
                  4.0 (7 reviews)
                </p>
              </div>
            </div>
          </div>
          <div style="margin-top: 24px;">
            <a href="#lessons" class="site-btn price-btn" style="margin-right: 12px;">View Lessons</a>
            <a href="#" class="site-btn buy-btn">Enroll Now</a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Video Player Section -->
    {% if first_lesson %}
    <div class="row" style="margin-bottom: 40px;">
      <div class="col-lg-10 offset-lg-1">
        <div style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.08);">
          <h4 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 24px;">
            Course Videos
            {% if showing_demo %}
            <span style="background: #28a745; color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: 600; margin-left: 12px;">FREE PREVIEW</span>
            {% endif %}
          </h4>
          <div class="row">
            <div class="col-lg-8">
              <div id="video-player-container" style="background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                {% if first_lesson.video_url %}
                <video id="course-video-player" 
                       controls
                       controlsList="nodownload"
                       {% if first_lesson.thumbnail %}poster="{{ first_lesson.thumbnail.url }}"{% endif %}
                       src="{{ first_lesson.video_url.url }}"
                       width="100%"
                       height="auto"
                       style="display: block; width: 100%;">
                  Sorry, your browser doesn't support embedded videos.
                </video>
                {% else %}
                <div style="padding: 60px; text-align: center; color: #fff;">
                  <i class="fa fa-video" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                  <p>No video available for this lesson</p>
                </div>
                {% endif %}
              </div>
              <div id="current-lesson-title" style="color: #1c1d1f; font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                {{ first_lesson.title }}
                {% if first_lesson.is_free_preview %}
                <span style="background: #28a745; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 8px;">FREE</span>
                {% endif %}
              </div>
              <p id="current-lesson-description" style="color: #6a6f73; font-size: 14px; margin: 0;">
                Lesson {{ first_lesson.position }} - Click on any lesson below to watch
              </p>
            </div>
            <div class="col-lg-4">
              <div style="background: #f7f9fa; padding: 20px; border-radius: 8px; max-height: 500px; overflow-y: auto;">
                <h5 style="color: #1c1d1f; font-size: 16px; font-weight: 700; margin-bottom: 16px;">Lessons</h5>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  {% for lesson in lessons %}
                  {% if lesson.is_free_preview or has_access %}
                  {% if first_lesson and first_lesson.id == lesson.id %}
                  {% if lesson.is_free_preview %}
                  <div class="lesson-item active-lesson lesson-item-active-free" 
                  {% else %}
                  <div class="lesson-item active-lesson lesson-item-active-premium" 
                  {% endif %}
                  {% else %}
                  <div class="lesson-item lesson-item-inactive" 
                  {% endif %}
                       {% if lesson.video_url %}data-video-url="{{ lesson.video_url.url }}"{% else %}data-video-url=""{% endif %}
                       {% if lesson.thumbnail %}data-thumbnail-url="{{ lesson.thumbnail.url }}"{% else %}data-thumbnail-url=""{% endif %}
                       data-lesson-title="{{ lesson.title }}"
                       data-lesson-position="{{ lesson.position }}"
                       data-is-free-preview="{% if lesson.is_free_preview %}true{% else %}false{% endif %}"
                       style="padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;"
                       onclick="playLesson(this)">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div class="{% if lesson.is_free_preview %}lesson-number-free{% else %}lesson-number-premium{% endif %}" style="width: 40px; height: 40px; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                        {{ lesson.position }}
                      </div>
                      <div style="flex: 1; min-width: 0;">
                        <div style="color: #1c1d1f; font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          {{ lesson.title }}
                          {% if lesson.is_free_preview %}
                          <span style="background: #28a745; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 6px;">FREE</span>
                          {% endif %}
                        </div>
                        <div style="color: #6a6f73; font-size: 12px;">
                          <i class="fa fa-play-circle" style="margin-right: 4px;"></i>Video
                        </div>
                      </div>
                      <i class="fa fa-play {% if lesson.is_free_preview %}lesson-play-icon-free{% else %}lesson-play-icon-premium{% endif %}" style="font-size: 12px;"></i>
                    </div>
                  </div>
                  {% else %}
                  <div class="lesson-item" style="padding: 12px; background: #f7f9fa; border: 2px solid #d1d7dc; border-radius: 6px; opacity: 0.6;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 40px; height: 40px; background: #6a6f73; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                        {{ lesson.position }}
                      </div>
                      <div style="flex: 1; min-width: 0;">
                        <div style="color: #6a6f73; font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          {{ lesson.title }}
                        </div>
                        <div style="color: #6a6f73; font-size: 12px;">
                          <i class="fa fa-lock" style="margin-right: 4px;"></i>Premium
                        </div>
                      </div>
                      <i class="fa fa-lock" style="color: #6a6f73; font-size: 12px;"></i>
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% elif not has_access and not has_demo_lessons %}
    <!-- Access Required Message -->
    <div class="row" style="margin-bottom: 40px;">
      <div class="col-lg-10 offset-lg-1">
        <div style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.08); text-align: center;">
          <h3 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 16px;">Upgrade Your Membership</h3>
          <p style="color: #6a6f73; font-size: 16px; margin-bottom: 24px;">You need to upgrade your membership to access course videos and lessons.</p>
          <a href="{% url 'memberships:select_membership' %}" class="site-btn">Upgrade Membership</a>
        </div>
      </div>
    </div>
    {% endif %}
    
    {% if showing_demo %}
    <!-- Demo Video Notice -->
    <div class="row" style="margin-bottom: 20px;">
      <div class="col-lg-10 offset-lg-1">
        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 16px 20px; border-radius: 8px;">
          <p style="color: #155724; font-size: 14px; margin: 0;">
            <i class="fa fa-info-circle" style="margin-right: 8px;"></i>
            You're watching a <strong>FREE PREVIEW</strong>. Upgrade your membership to access all course videos and lessons.
            <a href="{% url 'memberships:select_membership' %}" style="color: #0056d2; font-weight: 600; margin-left: 8px;">Upgrade Now â†’</a>
          </p>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <div class="course-list" style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.08);">
          <div class="cl-item" style="margin-bottom: 40px;">
            <h4 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 16px;">About this course</h4>
            <p style="color: #6a6f73; font-size: 16px; line-height: 1.6;">{{course.description}}</p>
          </div>
          <div class="cl-item" style="margin-bottom: 40px;">
            <h4 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 16px;">Certificate</h4>
            <p style="color: #6a6f73; font-size: 16px; line-height: 1.6;">Upon completion of this course, you will receive a free certificate that you can share with your professional network.</p>
          </div>
          <div class="cl-item" style="margin-bottom: 40px;">
            <h4 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 16px;">About the instructor</h4>
            <p style="color: #6a6f73; font-size: 16px; line-height: 1.6;">{{course.creator|capfirst}} is an experienced instructor with expertise in {{course.category|capfirst}}. Join thousands of students learning from this instructor.</p>
          </div>
          <div class="cl-item" id="lessons">
            <h4 style="color: #1c1d1f; font-size: 24px; font-weight: 700; margin-bottom: 24px;">Course content</h4>
            {% if lessons %}
              <div style="border: 1px solid #d1d7dc; border-radius: 8px; overflow: hidden;">
                {% for lesson in lessons %}
                  <div style="border-bottom: 1px solid #d1d7dc; padding: 16px 20px; background: #fff; transition: background 0.2s ease;">
                  {% if has_access or lesson.is_free_preview %}
                  <a href="{{ lesson.get_absolute_url }}" style="text-decoration: none; color: #1c1d1f; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <span style="color: #6a6f73; font-size: 14px; font-weight: 600; margin-right: 12px;">Lesson {{lesson.position}}</span>
                      <span style="color: #1c1d1f; font-size: 16px; font-weight: 500;">{{lesson.title}}</span>
                      {% if lesson.is_free_preview %}
                      <span style="background: #28a745; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 8px;">FREE</span>
                      {% endif %}
                    </div>
                    <i class="fa fa-chevron-right" style="color: #6a6f73;"></i>
                  </a>
                  {% else %}
                  <div style="display: flex; align-items: center; justify-content: space-between; opacity: 0.6;">
                    <div>
                      <span style="color: #6a6f73; font-size: 14px; font-weight: 600; margin-right: 12px;">Lesson {{lesson.position}}</span>
                      <span style="color: #1c1d1f; font-size: 16px; font-weight: 500;">{{lesson.title}}</span>
                    </div>
                    <i class="fa fa-lock" style="color: #6a6f73;"></i>
                  </div>
                  {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p style="color: #6a6f73; font-size: 16px;">No lessons available yet. Please check back later.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- single course section end -->


<!-- Page end -->

<script>
function playLesson(element) {
    // Get video data from the clicked lesson
    const videoUrl = element.getAttribute('data-video-url');
    const thumbnailUrl = element.getAttribute('data-thumbnail-url');
    const lessonTitle = element.getAttribute('data-lesson-title');
    const lessonPosition = element.getAttribute('data-lesson-position');
    
    // Get video player elements
    const videoPlayer = document.getElementById('course-video-player');
    const videoContainer = document.getElementById('video-player-container');
    const currentLessonTitle = document.getElementById('current-lesson-title');
    const currentLessonDescription = document.getElementById('current-lesson-description');
    
    // Check if video URL exists
    if (!videoUrl || videoUrl === '') {
        // Show message if no video
        videoContainer.innerHTML = '<div style="padding: 60px; text-align: center; color: #fff;"><i class="fa fa-video" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i><p>No video available for this lesson</p></div>';
    } else {
        // Restore video player if it was replaced
        if (!videoPlayer) {
            videoContainer.innerHTML = '<video id="course-video-player" controls controlsList="nodownload" width="100%" height="auto" style="display: block; width: 100%;">Sorry, your browser doesn\'t support embedded videos.</video>';
        }
        const player = document.getElementById('course-video-player');
        player.src = videoUrl;
        if (thumbnailUrl && thumbnailUrl !== '') {
            player.poster = thumbnailUrl;
        }
        player.load();
        player.play();
    }
    
    // Update lesson info
    if (currentLessonTitle) {
        const isFreePreview = element.getAttribute('data-is-free-preview') === 'true';
        if (isFreePreview) {
            currentLessonTitle.innerHTML = lessonTitle + ' <span style="background: #28a745; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 8px;">FREE</span>';
        } else {
            currentLessonTitle.textContent = lessonTitle;
        }
    }
    if (currentLessonDescription) {
        currentLessonDescription.textContent = 'Lesson ' + lessonPosition + ' - Click on any lesson below to watch';
    }
    
    // Update active lesson styling
    document.querySelectorAll('.lesson-item').forEach(item => {
        // Only update clickable lesson items (not locked ones)
        if (item.getAttribute('onclick')) {
            // Remove active classes
            item.classList.remove('lesson-item-active-free', 'lesson-item-active-premium');
            item.classList.add('lesson-item-inactive');
        }
    });
    const isFreePreview = element.getAttribute('data-is-free-preview') === 'true';
    // Remove inactive class and add appropriate active class
    element.classList.remove('lesson-item-inactive');
    if (isFreePreview) {
        element.classList.remove('lesson-item-active-premium');
        element.classList.add('lesson-item-active-free');
    } else {
        element.classList.remove('lesson-item-active-free');
        element.classList.add('lesson-item-active-premium');
    }
    
    // Scroll video player into view if needed
    if (videoContainer) {
        videoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
</script>

{% endblock %}
